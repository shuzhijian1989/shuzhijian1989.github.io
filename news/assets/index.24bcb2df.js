import"./vue.a2f518ee.js";import{M as e,m as t,a}from"./ant-design-vue.db4d48e3.js";import{Y as i}from"./table.81b98c8b.js";import{d as s}from"./dayjs.49e29cb2.js";import{_ as l,u as o,p as d}from"./index.7061e8ea.js";import{g as n,q as r,d as u,a as c,c as m,u as p}from"./studentAttendance.d03c3cd1.js";import{q as v,r as f,f as b,c as g,y as h,w as y,b8 as L,o as k,a2 as _,a3 as w,O as T,u as j,a1 as D,b as x,D as I,a as C,F as q,a8 as U,a5 as O,a9 as E,a7 as $,aw as A,n as P}from"./@vue.919ff404.js";import{f as R}from"./@ant-design.2e172c39.js";import"./@babel.6d5f88cb.js";import"./resize-observer-polyfill.f664b406.js";import"./vue-types.022beab3.js";import"./@ctrl.c020ccd3.js";import"./dom-align.0991ecc5.js";import"./lodash-es.36dcd19c.js";import"./async-validator.267d9719.js";import"./scroll-into-view-if-needed.61c672a4.js";import"./compute-scroll-into-view.17358474.js";/* empty css                    */import"./secure-ls.8c8acb46.js";import"./vue-router.907b547c.js";import"./nprogress.c2257662.js";import"./axios.7aed06b8.js";import"./qs.e55e9b28.js";import"./side-channel.ea627785.js";import"./get-intrinsic.8c87d952.js";import"./has-symbols.caae0f97.js";import"./has-proto.76cff6c7.js";import"./function-bind.cb3858f2.js";import"./has.c1051c46.js";import"./call-bind.208b5ef0.js";import"./object-inspect.e2cfb4a5.js";import"./vuex.f308ecec.js";import"./vuex-persistedstate.fa252374.js";import"./vue-grid-layout.a3ef67ec.js";const H=v({type:"0",name:"出入校",groupList:[],groupIds:[],mode:"1",weekList:[],attendanceTime:[],attendanceTimeDay:"",timeList:[{status:"",requiredTime:"",sort:"第1次考勤",scopeTime:[]}],isDevice:!0,deviceList:[]});const S=v({width:"500px",visible:!1,isEdit:!1,groupListOptions:[],checkedList:[],id:null});function Y(e,a){const i=e=>{S.visible=e};return{drawer:S,handleOpenDrawer:async(e,a)=>{if(S.isEdit=e,e){S.id=a.id;try{const e=await c({id:a.id}),{name:t,type:i,groupList:s,mode:l,weeks:o,startDate:d,endDate:n,timeList:r,isDevice:u,deviceList:m}=e.data;H.type=i+"",H.name=t,H.groupList=s.map((e=>({id:e.groupId}))),H.groupIds=s.map((e=>e.groupId));const p=s.map((e=>({id:e.groupId,showName:e.name})));S.groupListOptions=p,S.checkedList=p,H.mode=l+"",1===Number.parseInt(l)&&(H.attendanceTimeDay=d),0===Number.parseInt(l)&&(H.attendanceTime=[d,n],H.weekList=o.split(",").map((e=>1*e))),H.timeList=r.map((e=>({status:e.status+"",requiredTime:e.requiredTime,sort:e.sort,scopeTime:[e.startTime,e.endTime]}))),H.isDevice=u,H.deviceList=u?[]:m}catch(s){return t.error("数据异常，无法编辑，请联系管理员"),void i(!1)}}i(!0)},handleCloseDrawer:()=>{i(!1)}}}const N={style:{position:"absolute",right:"0",top:"10px"}};var F=l({__name:"createOrEdit",props:{visible:Boolean,isEdit:Boolean,deviceList:Array},emits:["update:visible"],setup(e,{emit:t}){const i=e,l=o(),n=h((()=>{const e=[];return l.state.base.commentJsonKeys.INIT_ROLL_LIST.forEach((t=>"classes"!==t.key&&e.push(t.level))),e})),r=v({selectTabs:[{tab:"添加考勤班级",key:2,checked:!0,disabled:n}],deviceIds:[],weekList:[{label:"周一",value:1},{label:"周二",value:2},{label:"周三",value:3},{label:"周四",value:4},{label:"周五",value:5},{label:"周六",value:6},{label:"周日",value:7}],visible:!1,drawerVisible:!1,checkedList:[],groupListOptions:[],submitBtnLoading:!1}),u=a.useForm,{drawer:c,handleCloseDrawer:b}=Y(),{formRef:R,formRule:S,errorTimeList:F,add:K,update:M}=function(){const e=f([]),t=v({name:[{required:!0,message:"请输入考勤名称"},{max:10,message:"最多10个字"}],groupIds:[{required:!0,message:"考勤班级不能为空"}],weekList:[{required:!0,message:"请选择循环日期"}],attendanceTimeDay:[{required:!0,message:"请选择考勤日期"}],attendanceTime:[{required:!0,trigger:"blur",validator:(e,t)=>{if(null==t)return Promise.reject("请选择考勤日期");if(t.length){const[e,a]=t;return s(a).diff(s(e),"days")>=7?Promise.resolve():Promise.reject("考勤循环日期须设置7天及以上")}return Promise.reject("请选择考勤日期")}}],timeList:[{required:!0,trigger:"blur",validator:(t,a)=>{e.value=[];for(let i=0;i<a.length;i++){const t=a[i];if(!t.requiredTime)return e.value.push(i+1),Promise.reject("请选择考勤时间");if(!t.status)return e.value.push(i+1),Promise.reject("请选择考勤时间 - 签到/签退");if(!t.scopeTime.length)return e.value.push(i+1),Promise.reject("请选择考勤时间 - 打卡范围");if(t.requiredTime&&t.scopeTime.length){const[a,s]=t.scopeTime,l="2022-03-31",o=new Date(`${l} ${t.requiredTime}`).getTime(),d=new Date(`${l} ${a}`).getTime();new Date(`${l} ${s}`).getTime()>o&&o>d||e.value.push(i+1)}}return e.value.length?Promise.reject("考勤时间须在打卡时间范围内"):Promise.resolve()}}],deviceList:[{required:!0,message:"请选择考勤设备"}],isDevice:[{required:!0,message:"请选择考勤设备"}]});return{formRef:H,formRule:t,errorTimeList:e,add:e=>new Promise(((t,a)=>{m(e).then((e=>{t(e)})).catch((()=>{a()}))})),update:e=>new Promise(((t,a)=>{p(e).then((e=>{t(e)})).catch((()=>{a()}))}))}}(),{resetFields:B,validate:V,validateInfos:z}=u(R,S),J=e=>e&&e<s().endOf("day");y((()=>i.visible),(e=>{var t;r.drawerVisible=e,i.isEdit?(r.groupListOptions=c.groupListOptions,r.checkedList=c.checkedList,r.deviceIds=null==(t=R.deviceList)?void 0:t.map((e=>e.deviceId))):(r.groupListOptions=[],r.deviceIds=[],r.checkedList=[])}));const G=(e,t)=>{R.deviceList=t};function Q(){const e=R.timeList.length;R.timeList.push({status:"",requiredTime:"",sort:`第${e+1}次考勤`,endTime:"",startTime:""}),P((()=>{const e=document.querySelector(".ant-drawer-body"),t=e.clientHeight;0===e.scrollTop?e.scrollTo(0,t-220):e.scrollTo(0,e.scrollTop+220)}))}function W(){const e={1:["groupIds","attendanceTimeDay","timeList"],0:["groupIds","weekList","attendanceTime","timeList"]},a=R.isDevice?e[R.mode]:e[R.mode].concat(["deviceList"]);V(a).then((e=>{r.submitBtnLoading=!0;const a=()=>{r.submitBtnLoading=!1};i.isEdit?M({...te(R),id:c.id}).then((e=>{t("submit",{msg:e.message,isEdit:!0}),X()})).finally(a):K(te(R)).then((e=>{t("submit",{msg:e.message,isEdit:!1}),X()})).finally(a)})).catch((e=>{}))}function X(){t("update:visible",!1),r.drawerVisible=!1,b(),r.groupListOptions=[],R.groupIds=[],R.groupList=[],r.checkedList=[],F.value=[],B()}function Z(e){r.groupListOptions=[...e],R.groupIds=e.map((e=>e.id)),R.groupList=e.map((e=>({id:e.id}))),r.checkedList=[...e]}function ee(e){r.checkedList=r.groupListOptions.filter((t=>e.includes(t.id)))}function te(e){const t={},a=e=>{const t=[];return e.forEach((e=>{const[a,i]=e.scopeTime,{requiredTime:s,status:l,sort:o}=e;t.push({startTime:a,endTime:i,requiredTime:s,sort:o,status:l})})),t};for(const i in e)if("1"!==R.mode||"attendanceTimeDay"!==i)if("0"!==R.mode||"attendanceTime"!==i)"weekList"==i&&(t.weekList=e[i].sort(((e,t)=>e-t))),"timeList"!==i?t[i]=e[i]:t.timeList=a(e[i]);else{const[a,s]=e[i];t.startDate=a,t.endDate=s}else{const a=e[i];t.startDate=a,t.endDate=a}return"1"===R.mode&&(delete t.attendanceTime,delete t.weekList),"0"===R.mode&&delete t.attendanceTimeDay,t}return(t,a)=>{const i=L("a-input"),s=L("a-form-item"),l=L("a-select"),o=L("plus-outlined"),n=L("a-button"),u=L("a-radio"),m=L("a-radio-group"),p=L("a-checkbox"),v=L("a-col"),f=L("a-row"),b=L("a-checkbox-group"),h=L("a-date-picker"),y=L("a-range-picker"),P=L("a-time-picker"),H=L("a-select-option"),S=L("a-time-range-picker"),Y=L("delete-outlined"),K=L("a-form"),M=L("a-drawer");return k(),_(M,{visible:r.drawerVisible,"onUpdate:visible":a[10]||(a[10]=e=>r.drawerVisible=e),title:(e.isEdit?"编辑":"新增")+"考勤",placement:"right",footerStyle:{textAlign:"center"},onClose:X,width:j(c).width},{footer:w((()=>[g(n,{onClick:X},{default:w((()=>[T("取消")])),_:1}),g(n,{loading:r.submitBtnLoading,style:{"margin-left":"12px"},type:"primary",onClick:W},{default:w((()=>[T("确认")])),_:1},8,["loading"])])),default:w((()=>[g(K,{labelCol:{span:24},scrollToFirstError:""},{default:w((()=>[g(s,{label:"考勤名称："},{default:w((()=>[g(i,{value:j(R).name,"onUpdate:value":a[0]||(a[0]=e=>j(R).name=e),placeholder:"请输入",disabled:""},null,8,["value"])])),_:1}),g(s,D({label:"考勤班级："},j(z).groupIds,{style:{position:"relative"}}),{default:w((()=>[g(l,{value:j(R).groupIds,"onUpdate:value":a[1]||(a[1]=e=>j(R).groupIds=e),placeholder:"请添加班级",options:r.groupListOptions,onChange:ee,"max-tag-count":4,mode:"multiple","field-names":{label:"showName",value:"id"}},null,8,["value","options"]),x("div",N,[g(j(d),{mode:"depa",tabs:r.selectTabs,visible:r.visible,"onUpdate:visible":a[2]||(a[2]=e=>r.visible=e),checked:r.checkedList,"onUpdate:checked":a[3]||(a[3]=e=>r.checkedList=e),onHandleOk:Z},{default:w((()=>[g(n,{type:"primary",size:"small",style:{position:"relative",bottom:"6px",right:"8px",display:"flex","align-items":"center","justify-content":"center"}},{icon:w((()=>[g(o)])),_:1})])),_:1},8,["tabs","visible","checked"])])])),_:1},16),g(s,{label:"考勤模式：",labelCol:{span:5},labelAlign:"left",style:{"align-items":"baseline"}},{default:w((()=>[g(m,{value:j(R).mode,"onUpdate:value":a[4]||(a[4]=e=>j(R).mode=e)},{default:w((()=>[g(u,{value:"1"},{default:w((()=>[T("单次")])),_:1}),g(u,{value:"0"},{default:w((()=>[T("按周循环")])),_:1})])),_:1},8,["value"])])),_:1}),g(I,{name:"timeList"},{default:w((()=>[0==j(R).mode?(k(),_(s,D({key:0,label:"考勤循环：",labelAlign:"left",labelCol:{span:5},style:{"align-items":"baseline"}},j(z).weekList),{default:w((()=>[g(b,{value:j(R).weekList,"onUpdate:value":a[5]||(a[5]=e=>j(R).weekList=e),style:{width:"100%"}},{default:w((()=>[g(f,null,{default:w((()=>[(k(!0),C(q,null,U(r.weekList,((e,t)=>(k(),_(v,{span:6,key:t,style:O({marginTop:([4,5,6].includes(t)?24:0)+"px"})},{default:w((()=>[g(p,{value:e.value},{default:w((()=>[T(E(e.label),1)])),_:2},1032,["value"])])),_:2},1032,["style"])))),128))])),_:1})])),_:1},8,["value"])])),_:1},16)):$("v-if",!0),1==j(R).mode?(k(),_(s,D({key:1,label:"考勤日期："},j(z).attendanceTimeDay),{default:w((()=>[g(h,{"disabled-date":J,value:j(R).attendanceTimeDay,"onUpdate:value":a[6]||(a[6]=e=>j(R).attendanceTimeDay=e),"value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["value"])])),_:1},16)):$("v-if",!0),0==j(R).mode?(k(),_(s,D({key:2,label:"考勤日期："},j(z).attendanceTime),{default:w((()=>[g(y,{style:{width:"100%"},"disabled-date":J,value:j(R).attendanceTime,"onUpdate:value":a[7]||(a[7]=e=>j(R).attendanceTime=e),"value-format":"YYYY-MM-DD"},null,8,["value"])])),_:1},16)):$("v-if",!0)])),_:1}),g(s,D({label:"考勤时间："},j(z).timeList,{validateStatus:"success",class:"timeList_formitem"}),{default:w((()=>[$("  "),g(I,{name:"timeList"},{default:w((()=>[(k(!0),C(q,null,U(j(R).timeList,((e,t)=>(k(),C("div",{class:"time_warp",key:t,style:O({border:(j(F).includes(t+1)?"1px solid #f5222d":"1px solid #00b78100")+" "})},[g(f,{gutter:36},{default:w((()=>[g(v,{span:8},{default:w((()=>[g(s,{label:"考勤序号",labelCol:{span:24}},{default:w((()=>[g(i,{value:e.sort,"onUpdate:value":t=>e.sort=t,disabled:"",placeholder:"请输入"},null,8,["value","onUpdate:value"])])),_:2},1024)])),_:2},1024),g(v,{span:8},{default:w((()=>[g(s,{label:"考勤时间",labelCol:{span:24}},{default:w((()=>[g(P,{value:e.requiredTime,"onUpdate:value":t=>e.requiredTime=t,format:"HH:mm","value-format":"HH:mm"},null,8,["value","onUpdate:value"])])),_:2},1024)])),_:2},1024),g(v,{span:8},{default:w((()=>[g(s,{label:"签到/签退",labelCol:{span:24}},{default:w((()=>[g(l,{value:e.status,"onUpdate:value":t=>e.status=t,placeholder:"请选择"},{default:w((()=>[g(H,{value:"0"},{default:w((()=>[T("签到")])),_:1}),g(H,{value:"1"},{default:w((()=>[T("签退")])),_:1})])),_:2},1032,["value","onUpdate:value"])])),_:2},1024)])),_:2},1024)])),_:2},1024),g(s,{label:"打卡范围限制",labelCol:{span:24}},{default:w((()=>[g(f,{gutter:16},{default:w((()=>[g(v,{span:21},{default:w((()=>[g(S,{format:"HH:mm",value:e.scopeTime,"onUpdate:value":t=>e.scopeTime=t,"value-format":"HH:mm",style:{width:"100%"}},null,8,["value","onUpdate:value"])])),_:2},1024),g(v,{span:3,style:{"text-align":"right"}},{default:w((()=>[j(R).timeList.length>1?(k(),_(n,{key:0,type:"text",onClick:e=>function(e){R.timeList.splice(e,1),R.timeList.forEach(((e,t)=>{e.sort=`第${t+1}次考勤`}))}(t)},{icon:w((()=>[g(Y,{style:{color:"rgb(147 147 147)"}})])),_:2},1032,["onClick"])):$("v-if",!0)])),_:2},1024)])),_:2},1024)])),_:2},1024)],4)))),128))])),_:1}),$("  ")])),_:1},16),g(s,null,{default:w((()=>[g(n,{type:"primary",ghost:"",onClick:Q,disabled:10==j(R).timeList.length},{icon:w((()=>[g(o)])),default:w((()=>[T(" 添加考勤 ")])),_:1},8,["disabled"])])),_:1}),g(s,D({label:"考勤设备：",labelAlign:"left"},j(z).isDevice,{labelCol:{span:5}}),{default:w((()=>[g(m,{value:j(R).isDevice,"onUpdate:value":a[8]||(a[8]=e=>j(R).isDevice=e)},{default:w((()=>[g(u,{value:!0},{default:w((()=>[T("全部设备")])),_:1}),g(u,{value:!1},{default:w((()=>[T("部分设备")])),_:1})])),_:1},8,["value"])])),_:1},16),j(R).isDevice?$("v-if",!0):(k(),_(s,A(D({key:0},j(z).deviceList)),{default:w((()=>[g(l,{placeholder:"请添加",value:r.deviceIds,"onUpdate:value":a[9]||(a[9]=e=>r.deviceIds=e),options:e.deviceList,onChange:G,"max-tag-count":4,mode:"multiple","field-names":{label:"machineName",value:"id"}},null,8,["value","options"])])),_:1},16))])),_:1})])),_:1},8,["visible","title","width"])}}},[["__scopeId","data-v-a39e70b8"],["__file","C:/Users/66406/Desktop/ydproject/cloudSystem3.0/cloud-system-2.0/src/views/appModel/studentAttendance/inAndOut/createOrEdit.vue"]]);const K={style:{padding:"16px"}},M=x("span",null,"新增或修改出入校规则后，都将在次日00:00生效",-1),B=x("div",{style:{height:"0px"}},null,-1),V=["onClick"];var z=l({__name:"index",setup(a){const{queryStudentAttendance:l,delItem:o,columns:d,deviceList:c}=function(){const t=f([]);return b((()=>{t.value.length||n().then((e=>{t.value=e.data||[]}))})),{deviceList:t,columns:[{title:"日期",dataIndex:"startDate",customRender:({record:e})=>e.mode?`${e.startDate}`:`${e.startDate} - ${e.endDate}`},{title:"考勤人数（人）",dataIndex:"personNum"},{title:"考勤设备",ellipsis:!0,dataIndex:"deviceName"},{title:"操作",width:"220px",key:"operation",customFilterDropdown:!0}],queryStudentAttendance:r,delItem:(t,a)=>new Promise(((i,s)=>{e.confirm({title:a,icon:g(R),okText:"确定",okType:"danger",cancelText:"取消",onOk(){u(t).then((e=>{i(e.message||"删除成功")})).catch((()=>{s()}))},onCancel(){s()}})}))}}(),{drawer:m,handleOpenDrawer:p}=Y(),y=v({selectedRowKeys:[]}),_=h((()=>0===y.selectedRowKeys.length)),D=(e,{id:a,startDate:i}={})=>{const l={batch:y.selectedRowKeys,single:[a]},d={batch:"确定批量删除出入校考勤?",single:`确定删除【${s(i).month()+1}月${s(i).date()}日】出入校考勤?`};o({ids:l[e]},d[e]).then((e=>{t.success(e),y.selectedRowKeys=[],O.update()}))},I=({msg:e,isEdit:a})=>{t.success(e),O.update(a)},U={onChange(e){y.selectedRowKeys=e}},O=(e,t)=>l({...e,type:0});return(e,t)=>{const a=L("plus-outlined"),s=L("a-button"),l=L("exclamation-circle-outlined"),o=L("a-tooltip");return k(),C("div",K,[g(j(i),{columns:j(d),loadData:O,"row-selection":U,rowKey:"id"},{handle:w((()=>[g(s,{type:"primary",style:{"margin-right":"12px"},onClick:t[0]||(t[0]=e=>j(p)(!1))},{icon:w((()=>[g(a)])),default:w((()=>[T(" 新增 ")])),_:1}),g(s,{danger:"",onClick:t[1]||(t[1]=e=>D("batch")),disabled:_.value},{default:w((()=>[T("批量删除 ")])),_:1},8,["disabled"])])),customFilterIcon:w((()=>[g(o,{placement:"bottomRight",class:"tipClass"},{title:w((()=>[M])),default:w((()=>[g(l,{style:{"font-size":"14px",color:"#757575"}})])),_:1})])),customFilterDropdown:w((()=>[B])),bodyCell:w((({column:e,record:t})=>["operation"===e.key?(k(),C(q,{key:0},[x("a",{style:{color:"var(--primary-color)"},type:"link",onClick:e=>j(p)(!0,t)},"编辑 ",8,V),g(s,{type:"link",danger:"",onClick:e=>D("single",t)},{default:w((()=>[T("删除")])),_:2},1032,["onClick"])],64)):$("v-if",!0)])),_:1},8,["columns"]),$(" 添加编辑 "),g(j(F),{visible:j(m).visible,"onUpdate:visible":t[2]||(t[2]=e=>j(m).visible=e),isEdit:j(m).isEdit,deviceList:j(c),onSubmit:I},null,8,["visible","isEdit","deviceList"]),$("  ")])}}},[["__file","C:/Users/66406/Desktop/ydproject/cloudSystem3.0/cloud-system-2.0/src/views/appModel/studentAttendance/inAndOut/index.vue"]]);export{z as default};
